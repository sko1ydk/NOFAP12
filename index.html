// Set current year
document.getElementById('year').textContent = new Date().getFullYear();

// DOM Elements
const startBtn = document.getElementById('start-btn');
const panicBtn = document.getElementById('panic-btn');
const breatheBtn = document.getElementById('breathe-btn');
const resetBtn = document.getElementById('reset-btn');
const disciplinedModeBtn = document.getElementById('disciplined-mode-btn');
const recordMessageBtn = document.getElementById('record-message-btn');
const statsBtn = document.getElementById('stats-btn');
const topWakeupBtn = document.getElementById('top-wakeup-btn');
const daysEl = document.getElementById('days');
const hoursEl = document.getElementById('hours');
const minutesEl = document.getElementById('minutes');
const secondsEl = document.getElementById('seconds');
const currentStreakEl = document.getElementById('current-streak');
const currentGoalEl = document.getElementById('current-goal');
const nextGoalEl = document.getElementById('next-goal');
const motivationTextEl = document.getElementById('motivation-text');
const motivationEl = document.getElementById('motivation');
const progressBarEl = document.getElementById('progress-bar');
const completedEl = document.getElementById('completed');
const redZoneEl = document.getElementById('red-zone');
const redZoneTimerEl = document.getElementById('red-zone-timer');
const redZoneMessageEl = document.getElementById('red-zone-message');
const exitRedZoneBtn = document.getElementById('exit-red-zone');
const playMessageBtn = document.getElementById('play-message-btn');
const breathingExerciseEl = document.getElementById('breathing-exercise');
const breathingCircleEl = document.getElementById('breathing-circle');
const breathingInstructionsEl = document.getElementById('breathing-instructions');
const exitBreathingBtn = document.getElementById('exit-breathing');
const breathingModeSelect = document.getElementById('breathing-mode');
const messageRecorderEl = document.getElementById('message-recorder');
const recordBtn = document.getElementById('record-btn');
const playVoiceBtn = document.getElementById('play-voice-btn');
const voiceRecorderStatus = document.getElementById('voice-recorder-status');
const voiceTimerEl = document.getElementById('voice-timer');
const messageText = document.getElementById('message-text');
const saveMessageBtn = document.getElementById('save-message-btn');
const cancelRecordingBtn = document.getElementById('cancel-recording-btn');
const messagePlaybackEl = document.getElementById('message-playback');
const voicePlaybackPanel = document.getElementById('voice-playback-panel');
const voicePlaybackBtn = document.getElementById('voice-playback-btn');
const voicePlaybackStatus = document.getElementById('voice-playback-status');
const textPlaybackPanel = document.getElementById('text-playback-panel');
const messageTextDisplay = document.getElementById('message-text-display');
const closePlaybackBtn = document.getElementById('close-playback-btn');
const notificationEl = document.getElementById('notification');
const mobileWarningEl = document.getElementById('mobile-warning');
const breatheAudio = document.getElementById('breathe-audio');

// User Account DOM Elements
const userAccountEl = document.getElementById('user-account');
const userAvatarEl = document.getElementById('user-avatar');
const userNameEl = document.getElementById('user-name');
const userStatsEl = document.getElementById('user-stats');
const logoutBtn = document.getElementById('logout-btn');
const settingsBtn = document.getElementById('settings-btn');
const loginModalEl = document.getElementById('login-modal');
const closeLoginModalBtn = document.getElementById('close-login-modal');
const loginFormEl = document.getElementById('login-form');
const signupFormEl = document.getElementById('signup-form');
const loginUsernameEl = document.getElementById('login-username');
const loginPasswordEl = document.getElementById('login-password');
const loginBtn = document.getElementById('login-btn');
const signupUsernameEl = document.getElementById('signup-username');
const signupPasswordEl = document.getElementById('signup-password');
const signupConfirmEl = document.getElementById('signup-confirm');
const signupBtn = document.getElementById('signup-btn');
const switchToSignupEl = document.getElementById('switch-to-signup');
const switchToLoginEl = document.getElementById('switch-to-login');

// Settings Modal DOM Elements
const settingsModalEl = document.getElementById('settings-modal');
const closeSettingsModalBtn = document.getElementById('close-settings-modal');
const dailyRemindersToggle = document.getElementById('daily-reminders-toggle');
const milestoneAlertsToggle = document.getElementById('milestone-alerts-toggle');
const motivationalMessagesToggle = document.getElementById('motivational-messages-toggle');
const saveDataToggle = document.getElementById('save-data-toggle');
const clearDataBtn = document.getElementById('clear-data-btn');
const changePasswordBtn = document.getElementById('change-password-btn');
const deleteAccountBtn = document.getElementById('delete-account-btn');
const saveSettingsBtn = document.getElementById('save-settings-btn');

// Statistics Modal DOM Elements
const statsModalEl = document.getElementById('stats-modal');
const closeStatsModalBtn = document.getElementById('close-stats-modal');
const totalDaysEl = document.getElementById('total-days');
const longestStreakEl = document.getElementById('longest-streak');
const goalsCompletedEl = document.getElementById('goals-completed');
const relapsesEl = document.getElementById('relapses');
const exportStatsBtn = document.getElementById('export-stats-btn');

// Red Zone Distraction Exercise
const mathProblemEl = document.getElementById('math-problem');
const mathAnswerEl = document.getElementById('math-answer');
const checkAnswerBtn = document.getElementById('check-answer');
let currentMathAnswer = 0;

// Wake-Up Mode DOM Elements
const wakeupModeEl = document.getElementById('wakeup-mode');
const exitWakeupBtn = document.getElementById('exit-wakeup');
const takeActionBtn = document.getElementById('take-action-btn');
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const interactiveItems = document.querySelectorAll('.interactive-item');
const tacticCheckboxes = document.querySelectorAll('.tactic-checkbox');

// Motivational quotes
const motivationalQuotes = [
    { text: "He who conquers himself is the mightiest warrior. Your mind is the battlefield.", author: "Confucius" },
    { text: "The unexamined life is not worth living. Question your desires, don't be enslaved by them.", author: "Socrates" },
    { text: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", author: "Aristotle" },
    { text: "The greatest glory in living lies not in never falling, but in rising every time we fall.", author: "Nelson Mandela" },
    { text: "Freedom is not worth having if it does not include the freedom to make mistakes.", author: "Mahatma Gandhi" },
    { text: "The only way to deal with an unfree world is to become so absolutely free that your very existence is an act of rebellion.", author: "Albert Camus" },
    { text: "He who has a why to live can bear almost any how. Find your purpose, not your pleasure.", author: "Friedrich Nietzsche" },
    { text: "The mind is everything. What you think you become. Control your thoughts, control your destiny.", author: "Buddha" },
    { text: "I count him braver who overcomes his desires than him who conquers his enemies.", author: "Aristotle" },
    { text: "The first and greatest victory is to conquer self. To be conquered by self is the worst shame.", author: "Plato" },
    { text: "Real men don't let temporary pleasures control their destiny. Start your journey to greatness now.", author: "The War Room" },
    { text: "Weakness is a choice. Strength is a habit. Which one are you choosing today?", author: "Tate Philosophy" },
    { text: "Every second you resist, you build your empire of self-discipline. Kings don't indulge in weakness.", author: "King's Mindset" },
    { text: "Your desire for instant gratification is what keeps you average. Break free and become legendary.", author: "Top G" },
    { text: "Pain is temporary, but regret lasts forever. Endure the pain of discipline or suffer the pain of regret.", author: "Hustler's University" },
    { text: "The modern world wants you weak, distracted, and complacent. Reject mediocrity. Embrace greatness.", author: "The Real World" },
    { text: "Your mind is the most powerful weapon you possess. Don't let it be hijacked by cheap dopamine hits.", author: "Tate Speech" },
    { text: "Every time you say no to weakness, you say yes to your future self. Build that future now.", author: "King's Code" },
    { text: "Excuses are for the weak. Solutions are for the strong. Which side are you on?", author: "War Room Tactics" },
    { text: "The path to greatness is paved with discipline, sacrifice, and unwavering focus. Start walking it now.", author: "Top G Mindset" }
];

// Red Zone messages
const redZoneMessages = [
    "IF YOU GIVE IN NOW, YOU'RE FAILING YOUR FUTURE SELF!",
    "EVERY TIME YOU RELAPSE, YOU PUSH SUCCESS FURTHER AWAY!",
    "THIS WEAKNESS WILL COST YOU YOUR DREAMS AND YOUR FAMILY!",
    "YOU'LL NEVER BE RICH IF YOU CAN'T CONTROL YOUR URGES!",
    "YOUR COMPETITORS ARE DISCIPLINED WHILE YOU'RE INDULGING!",
    "GIVE IN NOW AND YOU'RE CHOOSING MEDIOCRITY OVER GREATNESS!",
    "THIS MOMENT OF WEAKNESS COULD RUIN YOUR ENTIRE FUTURE!",
    "REAL MEN DON'T SURRENDER TO TEMPORARY PLEASURES!",
    "YOUR FUTURE FAMILY DESERVES A STRONG MAN, NOT A WEAK ONE!",
    "EVERY SECOND YOU RESIST BUILDS YOUR EMPIRE OF DISCIPLINE!"
];

// Timer variables
let timerInterval = null;
let timeLeft = 48 * 60 * 60; // 48 hours in seconds
let initialTime = 48 * 60 * 60; // 48 hours in seconds
let streak = 0;
let isRunning = false;
let endTime = null;
let disciplinedMode = false;

// User Account variables
let currentUser = null;
let users = [];
let settings = {
    dailyReminders: false,
    milestoneAlerts: true,
    motivationalMessages: true,
    saveData: true
};

// Statistics variables
let stats = {
    totalDays: 0,
    longestStreak: 0,
    goalsCompleted: 0,
    relapses: 0
};

// Red Zone variables
let redZoneInterval = null;
let redZoneTimeLeft = 300; // 5 minutes in seconds
let redZoneMessageInterval = null;

// Breathing exercise variables
let breathingInterval = null;
let breathingStep = 0; // 0: inhale, 1: hold, 2: exhale
let breathingTimeLeft = 4; // Start with inhale time
let breathingMode = 'box'; // default breathing mode

// Message recording variables
let mediaRecorder = null;
let audioChunks = [];
let recordedAudio = null;
let recordingTimer = null;
let recordingSeconds = 0;
let savedMessage = {
    voice: null,
    text: null
};

// Notification variables
let notificationPermission = false;
let dailyReminderInterval = null;
let motivationalMessageInterval = null;

// Initialize app
function init() {
    // Load saved data from localStorage
    loadData();
    
    // Check if user is logged in
    if (!currentUser) {
        showLoginModal();
    } else {
        updateUserAccountDisplay();
    }
    
    // Update display with loaded data
    updateDisplay();
    updateStreakInfo();
    updateDisciplinedMode();
    updateSettingsToggles();
    
    // Check if timer was running when page was last closed
    if (endTime && endTime > Date.now()) {
        startTimer();
        isRunning = true;
        startBtn.textContent = "MISSION IN PROGRESS";
        startBtn.disabled = true;
    } else if (endTime && endTime <= Date.now()) {
        // Timer has expired, complete the goal
        completeGoal();
    }
    
    // Start quote rotation
    startQuoteRotation();
    
    // Request notification permission
    requestNotificationPermission();
    
    // Check if mobile device
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        mobileWarningEl.style.display = 'block';
    }
    
    // Start daily reminders if enabled
    if (settings.dailyReminders) {
        startDailyReminders();
    }
    
    // Start motivational messages if enabled
    if (settings.motivationalMessages) {
        startMotivationalMessages();
    }
}

// Load data from localStorage
function loadData() {
    try {
        // Load users
        const savedUsers = localStorage.getItem('kingUsers');
        if (savedUsers) {
            users = JSON.parse(savedUsers);
        }
        
        // Load current user
        const savedCurrentUser = localStorage.getItem('kingCurrentUser');
        if (savedCurrentUser) {
            currentUser = JSON.parse(savedCurrentUser);
        }
        
        // Load user data
        if (currentUser) {
            const userData = localStorage.getItem(`kingUserData_${currentUser.username}`);
            if (userData) {
                const data = JSON.parse(userData);
                streak = data.streak || 0;
                initialTime = data.initialTime || 48 * 60 * 60;
                timeLeft = data.timeLeft || 48 * 60 * 60;
                endTime = data.endTime || null;
                disciplinedMode = data.disciplinedMode || false;
                stats = data.stats || {
                    totalDays: 0,
                    longestStreak: 0,
                    goalsCompleted: 0,
                    relapses: 0
                };
                
                // Load saved message if available
                if (data.savedMessage) {
                    savedMessage = data.savedMessage;
                }
                
                // If we have an end time, calculate the current timeLeft
                if (endTime) {
                    const now = Date.now();
                    if (now < endTime) {
                        timeLeft = Math.floor((endTime - now) / 1000);
                    } else {
                        // If the timer has expired, trigger completion
                        timeLeft = 0;
                    }
                }
            }
        }
        
        // Load settings
        const savedSettings = localStorage.getItem('kingSettings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
        }
    } catch (e) {
        console.error('Error loading data from localStorage:', e);
    }
}

// Save data to localStorage
function saveData() {
    try {
        // Save users
        localStorage.setItem('kingUsers', JSON.stringify(users));
        
        // Save current user
        if (currentUser) {
            localStorage.setItem('kingCurrentUser', JSON.stringify(currentUser));
            
            // Save user data
            const data = {
                streak,
                initialTime,
                timeLeft,
                endTime,
                disciplinedMode,
                stats,
                savedMessage
            };
            localStorage.setItem(`kingUserData_${currentUser.username}`, JSON.stringify(data));
        }
        
        // Save settings
        localStorage.setItem('kingSettings', JSON.stringify(settings));
    } catch (e) {
        console.error('Error saving data to localStorage:', e);
    }
}

// Update display
function updateDisplay() {
    const days = Math.floor(timeLeft / (24 * 60 * 60));
    const hours = Math.floor((timeLeft % (24 * 60 * 60)) / (60 * 60));
    const minutes = Math.floor((timeLeft % (60 * 60)) / 60);
    const seconds = timeLeft % 60;
    
    daysEl.textContent = days.toString().padStart(2, '0');
    hoursEl.textContent = hours.toString().padStart(2, '0');
    minutesEl.textContent = minutes.toString().padStart(2, '0');
    secondsEl.textContent = seconds.toString().padStart(2, '0');
    
    // Update progress bar
    const progress = ((initialTime - timeLeft) / initialTime) * 100;
    progressBarEl.style.width = `${progress}%`;
    
    // Update motivation based on time left
    if (timeLeft < 60 * 60) {
        updateMotivation("The final hour is where legends are made. Don't you dare give up now.", "Top G");
    } else if (timeLeft < 24 * 60 * 60) {
        updateMotivation("You're in the final stretch. Push through the pain and claim your victory.", "King's Mindset");
    }
    
    // Update user stats
    if (currentUser) {
        const currentDay = Math.floor((initialTime - timeLeft) / (24 * 60 * 60)) + 1;
        userStatsEl.textContent = `Day ${currentDay}`;
    }
    
    // Save current state
    saveData();
}

// Update streak info
function updateStreakInfo() {
    currentStreakEl.textContent = streak;
    currentGoalEl.textContent = `${Math.floor(initialTime / (60 * 60))}h`;
    nextGoalEl.textContent = `${Math.floor((initialTime * 2) / (60 * 60))}h`;
}

// Update motivation
function updateMotivation(text, author) {
    motivationTextEl.textContent = text;
    document.querySelector('.motivation .author').textContent = `- ${author}`;
}

// Get random motivation
function getRandomMotivation() {
    const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
    updateMotivation(quote.text, quote.author);
}

// Start timer
function startTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    // Set the end time for the current countdown
    endTime = Date.now() + (timeLeft * 1000);
    saveData();
    
    timerInterval = setInterval(() => {
        const now = Date.now();
        
        // Calculate remaining time in seconds
        if (now < endTime) {
            timeLeft = Math.floor((endTime - now) / 1000);
            updateDisplay();
        } else {
            // Timer has completed
            timeLeft = 0;
            updateDisplay();
            completeGoal();
        }
    }, 1000);
}

// Start mission
function startMission() {
    if (isRunning) return;
    
    isRunning = true;
    
    // Reset to initial values
    streak = 0;
    initialTime = 48 * 60 * 60;
    timeLeft = initialTime;
    
    startBtn.textContent = "MISSION IN PROGRESS";
    startBtn.disabled = true;
    
    showNotification("Mission started! Stay strong, King.");
    
    updateStreakInfo();
    startTimer();
    saveData();
}

// Complete goal
function completeGoal() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    streak++;
    initialTime *= 2;
    timeLeft = initialTime;
    
    // Update statistics
    stats.goalsCompleted++;
    stats.totalDays += Math.floor(initialTime / (24 * 60 * 60));
    if (streak > stats.longestStreak) {
        stats.longestStreak = streak;
    }
    
    // Reset end time
    endTime = null;
    
    updateDisplay();
    updateStreakInfo();
    updateStatistics();
    
    // Show completion message
    completedEl.style.display = 'block';
    setTimeout(() => {
        completedEl.style.display = 'none';
    }, 3000);
    
    showNotification("Mission accomplished! You're becoming stronger.");
    
    // Send milestone notification if enabled
    if (settings.milestoneAlerts && notificationPermission) {
        sendNotification("Mission Accomplished!", "You've completed another goal. Keep pushing forward!");
    }
    
    // Update motivation
    const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
    updateMotivation(quote.text, quote.author);
    
    // Save data
    saveData();
    
    // Start timer for next goal
    startTimer();
}

// Reset streak
function resetStreak() {
    if (confirm("Are you sure you want to reset your streak? This is a sign of weakness.")) {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Update statistics
        stats.relapses++;
        
        timeLeft = 48 * 60 * 60;
        initialTime = 48 * 60 * 60;
        streak = 0;
        isRunning = false;
        endTime = null;
        
        startBtn.textContent = "START MISSION";
        startBtn.disabled = false;
        
        updateDisplay();
        updateStreakInfo();
        updateStatistics();
        
        updateMotivation("Failure is not final, but giving up is. Get back on your feet and fight for your greatness.", "Tate Philosophy");
        showNotification("Streak reset. Time to start over and prove your strength.");
        
        // Save reset data
        saveData();
    }
}

// Toggle Disciplined Mode
function toggleDisciplinedMode() {
    disciplinedMode = !disciplinedMode;
    updateDisciplinedMode();
    saveData();
    
    if (disciplinedMode) {
        showNotification("Disciplined Mode activated. Focus on your journey, not the timer.");
    } else {
        showNotification("Disciplined Mode deactivated. Timer and progress are now visible.");
    }
}

// Update Disciplined Mode display
function updateDisciplinedMode() {
    if (disciplinedMode) {
        document.body.classList.add('disciplined-mode');
        disciplinedModeBtn.classList.add('active');
        disciplinedModeBtn.textContent = "DISCIPLINED MODE: ON";
    } else {
        document.body.classList.remove('disciplined-mode');
        disciplinedModeBtn.classList.remove('active');
        disciplinedModeBtn.textContent = "DISCIPLINED MODE";
    }
}

// Show notification
function showNotification(message) {
    notificationEl.textContent = message;
    notificationEl.classList.add('show');
    
    setTimeout(() => {
        notificationEl.classList.remove('show');
    }, 3000);
}

// Request notification permission
function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            notificationPermission = permission === 'granted';
        });
    }
}

// Send browser notification
function sendNotification(title, body) {
    if (notificationPermission && 'Notification' in window) {
        new Notification(title, {
            body: body,
            icon: 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80'
        });
    }
}

// Start daily reminders
function startDailyReminders() {
    if (dailyReminderInterval) {
        clearInterval(dailyReminderInterval);
    }
    
    // Send reminder at 9 AM every day
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(9, 0, 0, 0);
    
    const timeUntilTomorrow = tomorrow - now;
    
    dailyReminderInterval = setTimeout(() => {
        if (settings.dailyReminders && notificationPermission) {
            sendNotification("Daily Reminder", "Stay strong today! Every day without porn is a victory.");
        }
        
        // Set up recurring daily reminders
        setInterval(() => {
            if (settings.dailyReminders && notificationPermission) {
                sendNotification("Daily Reminder", "Stay strong today! Every day without porn is a victory.");
            }
        }, 24 * 60 * 60 * 1000); // 24 hours
    }, timeUntilTomorrow);
}

// Start motivational messages
function startMotivationalMessages() {
    if (motivationalMessageInterval) {
        clearInterval(motivationalMessageInterval);
    }
    
    // Send motivational message every 4 hours
    motivationalMessageInterval = setInterval(() => {
        if (settings.motivationalMessages && notificationPermission) {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            sendNotification("Motivational Message", `${quote.text} - ${quote.author}`);
        }
    }, 4 * 60 * 60 * 1000); // 4 hours
}

// Red Zone functions
function activateRedZone() {
    redZoneEl.classList.add('active');
    redZoneTimeLeft = 300; // 5 minutes
    updateRedZoneTimer();
    
    // Generate math problem
    generateMathProblem();
    
    // Show play message button if there's a saved message
    if (savedMessage.voice || savedMessage.text) {
        playMessageBtn.style.display = 'block';
    } else {
        playMessageBtn.style.display = 'none';
    }
    
    // Start countdown
    redZoneInterval = setInterval(() => {
        redZoneTimeLeft--;
        updateRedZoneTimer();
        
        if (redZoneTimeLeft <= 0) {
            exitRedZone();
        }
    }, 1000);
    
    // Start message cycling
    cycleRedZoneMessages();
    redZoneMessageInterval = setInterval(cycleRedZoneMessages, 3000);
    
    showNotification("Red Zone activated! Fight the urge!");
}

function updateRedZoneTimer() {
    const minutes = Math.floor(redZoneTimeLeft / 60);
    const seconds = redZoneTimeLeft % 60;
    redZoneTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function cycleRedZoneMessages() {
    const message = redZoneMessages[Math.floor(Math.random() * redZoneMessages.length)];
    redZoneMessageEl.textContent = message;
}

function exitRedZone() {
    redZoneEl.classList.remove('active');
    clearInterval(redZoneInterval);
    clearInterval(redZoneMessageInterval);
    showNotification("You conquered the urge! Stay strong.");
}

// Generate math problem for distraction
function generateMathProblem() {
    const operations = ['+', '-', '×'];
    const operation = operations[Math.floor(Math.random() * operations.length)];
    let num1, num2, answer;
    
    switch (operation) {
        case '+':
            num1 = Math.floor(Math.random() * 50) + 1;
            num2 = Math.floor(Math.random() * 50) + 1;
            answer = num1 + num2;
            break;
        case '-':
            num1 = Math.floor(Math.random() * 50) + 20;
            num2 = Math.floor(Math.random() * 20) + 1;
            answer = num1 - num2;
            break;
        case '×':
            num1 = Math.floor(Math.random() * 12) + 1;
            num2 = Math.floor(Math.random() * 12) + 1;
            answer = num1 * num2;
            break;
    }
    
    mathProblemEl.textContent = `${num1} ${operation} ${num2} = ?`;
    currentMathAnswer = answer;
    mathAnswerEl.value = '';
}

function checkMathAnswer() {
    const userAnswer = parseInt(mathAnswerEl.value);
    if (userAnswer === currentMathAnswer) {
        showNotification("Correct! You're regaining control.");
        generateMathProblem();
    } else {
        showNotification("Try again. Focus!");
        mathAnswerEl.value = '';
        mathAnswerEl.focus();
    }
}

// Breathing exercise functions
function getBreathingTimes() {
    switch (breathingMode) {
        case 'box':
            return { inhale: 4, hold: 4, exhale: 4 };
        case 'wim-hof':
            return { inhale: 30, hold: 15, exhale: 15 };
        case '4-7-8':
            return { inhale: 4, hold: 7, exhale: 8 };
        case 'coherent':
            return { inhale: 5, hold: 0, exhale: 5 };
        case 'resonance':
            return { inhale: 6, hold: 0, exhale: 6 };
        default:
            return { inhale: 4, hold: 4, exhale: 4 };
    }
}

function startBreathingExercise() {
    breathingMode = breathingModeSelect.value;
    breathingExerciseEl.classList.add('active');
    breathingStep = 0;
    const times = getBreathingTimes();
    breathingTimeLeft = times.inhale;
    updateBreathingDisplay();
    
    // Play the breathing audio if available
    if (breatheAudio) {
        breatheAudio.play().catch(e => console.log("Audio play failed:", e));
    }
    
    breathingInterval = setInterval(() => {
        breathingTimeLeft--;
        
        if (breathingTimeLeft <= 0) {
            breathingStep = (breathingStep + 1) % 3;
            const times = getBreathingTimes();
            
            if (breathingStep === 0) {
                breathingTimeLeft = times.inhale;
            } else if (breathingStep === 1) {
                breathingTimeLeft = times.hold;
            } else {
                breathingTimeLeft = times.exhale;
            }
        }
        
        updateBreathingDisplay();
    }, 1000);
    
    showNotification("Breathing exercise started. Focus on your breath.");
}

function updateBreathingDisplay() {
    const times = getBreathingTimes();
    breathingCircleEl.className = 'breathing-circle';
    
    if (breathingStep === 0) {
        breathingCircleEl.classList.add('inhale');
        breathingCircleEl.textContent = 'INHALE';
        breathingInstructionsEl.textContent = `Take a deep breath in through your nose for ${times.inhale} seconds`;
    } else if (breathingStep === 1) {
        if (times.hold > 0) {
            breathingCircleEl.classList.add('hold');
            breathingCircleEl.textContent = 'HOLD';
            breathingInstructionsEl.textContent = `Hold your breath for ${times.hold} seconds`;
        } else {
            // Skip hold step if time is 0
            breathingStep = 2;
            breathingTimeLeft = times.exhale;
            updateBreathingDisplay();
            return;
        }
    } else {
        breathingCircleEl.classList.add('exhale');
        breathingCircleEl.textContent = 'EXHALE';
        breathingInstructionsEl.textContent = `Exhale slowly through your mouth for ${times.exhale} seconds`;
    }
}

function exitBreathingExercise() {
    breathingExerciseEl.classList.remove('active');
    clearInterval(breathingInterval);
    
    // Pause and reset the breathing audio
    if (breatheAudio) {
        breatheAudio.pause();
        breatheAudio.currentTime = 0;
    }
    
    showNotification("Breathing exercise completed. You're in control.");
}

// Message recording functions
function openMessageRecorder() {
    messageRecorderEl.classList.add('active');
    
    // Reset recorder state
    audioChunks = [];
    recordedAudio = null;
    mediaRecorder = null;
    recordingSeconds = 0;
    
    // Reset UI
    recordBtn.classList.remove('recording');
    recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
    playVoiceBtn.style.display = 'none';
    voiceRecorderStatus.textContent = 'Click the microphone to start recording';
    voiceTimerEl.textContent = '00:00';
    voiceTimerEl.classList.remove('active');
    messageText.value = '';
}

function closeMessageRecorder() {
    messageRecorderEl.classList.remove('active');
}

// Format time for display
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Update recording timer
function updateRecordingTimer() {
    recordingSeconds++;
    voiceTimerEl.textContent = formatTime(recordingSeconds);
}

async function startRecording() {
    try {
        // Check if mediaRecorder is already recording
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            stopRecording();
            return;
        }
        
        // Request access to the microphone
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            } 
        });
        
        // Create a new MediaRecorder instance
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus'
        });
        
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            recordedAudio = URL.createObjectURL(audioBlob);
            
            // Show play button
            playVoiceBtn.style.display = 'block';
            voiceRecorderStatus.textContent = 'Recording complete. Click play to review.';
            voiceTimerEl.classList.remove('active');
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.onerror = (event) => {
            console.error('MediaRecorder error:', event.error);
            voiceRecorderStatus.textContent = 'Error: Recording failed. Please try again.';
            recordBtn.classList.remove('recording');
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        };
        
        // Start recording
        mediaRecorder.start();
        
        // Update UI
        recordBtn.classList.add('recording');
        recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
        voiceRecorderStatus.textContent = 'Recording... Click to stop';
        
        // Start timer
        voiceTimerEl.classList.add('active');
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
    } catch (err) {
        console.error('Error accessing microphone:', err);
        let errorMessage = 'Error: Could not access microphone. ';
        
        if (err.name === 'NotAllowedError') {
            errorMessage += 'Please allow microphone access and try again.';
        } else if (err.name === 'NotFoundError') {
            errorMessage += 'No microphone found. Please connect a microphone and try again.';
        } else {
            errorMessage += 'Please check your device settings and try again.';
        }
        
        voiceRecorderStatus.textContent = errorMessage;
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        
        // Clear timer
        if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
        }
        
        // Update UI
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
    }
}

function playRecordedAudio() {
    if (recordedAudio) {
        const audio = new Audio(recordedAudio);
        
        // Update UI
        playVoiceBtn.innerHTML = '<i class="fas fa-pause"></i>';
        voiceRecorderStatus.textContent = 'Playing recording...';
        
        audio.onended = () => {
            playVoiceBtn.innerHTML = '<i class="fas fa-play"></i> PLAY RECORDING';
            voiceRecorderStatus.textContent = 'Recording complete. Click play to review.';
        };
        
        audio.play();
    }
}

function saveMessage() {
    // Check if at least one type of message is recorded
    if (!recordedAudio && !messageText.value.trim()) {
        showNotification('Please record a voice message or write a text message before saving.');
        return;
    }
    
    // Save voice message if available
    if (recordedAudio) {
        // Convert blob URL to base64 for storage
        fetch(recordedAudio)
            .then(response => response.blob())
            .then(blob => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    savedMessage.voice = reader.result;
                    
                    // Save text message if available
                    if (messageText.value.trim()) {
                        savedMessage.text = messageText.value;
                    }
                    
                    saveData();
                    showNotification('Message saved successfully!');
                    closeMessageRecorder();
                };
                reader.readAsDataURL(blob);
            })
            .catch(err => {
                console.error('Error processing audio:', err);
                showNotification('Error saving message. Please try again.');
            });
    } else if (messageText.value.trim()) {
        // Only text message is available
        savedMessage.text = messageText.value;
        saveData();
        showNotification('Message saved successfully!');
        closeMessageRecorder();
    }
}

function playSavedMessage() {
    if (!savedMessage.voice && !savedMessage.text) {
        showNotification('No saved message found.');
        return;
    }
    
    messagePlaybackEl.classList.add('active');
    
    // Show/hide panels based on what's available
    if (savedMessage.voice) {
        voicePlaybackPanel.style.display = 'block';
        
        // Create audio element from base64
        const audio = new Audio(savedMessage.voice);
        
        voicePlaybackBtn.onclick = () => {
            if (audio.paused) {
                audio.play();
                voicePlaybackBtn.innerHTML = '<i class="fas fa-pause"></i>';
                voicePlaybackStatus.textContent = 'Playing message...';
                
                audio.onended = () => {
                    voicePlaybackBtn.innerHTML = '<i class="fas fa-play"></i>';
                    voicePlaybackStatus.textContent = 'Click to play your message';
                };
            } else {
                audio.pause();
                voicePlaybackBtn.innerHTML = '<i class="fas fa-play"></i>';
                voicePlaybackStatus.textContent = 'Click to play your message';
            }
        };
    } else {
        voicePlaybackPanel.style.display = 'none';
    }
    
    if (savedMessage.text) {
        textPlaybackPanel.style.display = 'block';
        messageTextDisplay.textContent = savedMessage.text;
    } else {
        textPlaybackPanel.style.display = 'none';
    }
}

function closeMessagePlayback() {
    messagePlaybackEl.classList.remove('active');
    
    // Reset audio playback
    if (voicePlaybackBtn) {
        voicePlaybackBtn.innerHTML = '<i class="fas fa-play"></i>';
        voicePlaybackStatus.textContent = 'Click to play your message';
    }
}

// User Account functions
function showLoginModal() {
    loginModalEl.classList.add('active');
}

function hideLoginModal() {
    loginModalEl.classList.remove('active');
}

function switchToSignup() {
    loginFormEl.style.display = 'none';
    signupFormEl.style.display = 'block';
}

function switchToLogin() {
    loginFormEl.style.display = 'block';
    signupFormEl.style.display = 'none';
}

function login() {
    const username = loginUsernameEl.value.trim();
    const password = loginPasswordEl.value.trim();
    
    if (!username || !password) {
        showNotification('Please enter both username and password.');
        return;
    }
    
    // Find user
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        currentUser = user;
        saveData();
        updateUserAccountDisplay();
        hideLoginModal();
        showNotification('Login successful! Welcome back.');
    } else {
        showNotification('Invalid username or password.');
    }
}

function signup() {
    const username = signupUsernameEl.value.trim();
    const password = signupPasswordEl.value.trim();
    const confirm = signupConfirmEl.value.trim();
    
    if (!username || !password || !confirm) {
        showNotification('Please fill in all fields.');
        return;
    }
    
    if (password !== confirm) {
        showNotification('Passwords do not match.');
        return;
    }
    
    // Check if username already exists
    if (users.some(u => u.username === username)) {
        showNotification('Username already exists.');
        return;
    }
    
    // Create new user
    const newUser = {
        username,
        password,
        createdAt: new Date().toISOString()
    };
    
    users.push(newUser);
    currentUser = newUser;
    
    // Initialize user data
    const userData = {
        streak: 0,
        initialTime: 48 * 60 * 60,
        timeLeft: 48 * 60 * 60,
        endTime: null,
        disciplinedMode: false,
        stats: {
            totalDays: 0,
            longestStreak: 0,
            goalsCompleted: 0,
            relapses: 0
        },
        savedMessage: {
            voice: null,
            text: null
        }
    };
    
    localStorage.setItem(`kingUserData_${username}`, JSON.stringify(userData));
    
    saveData();
    updateUserAccountDisplay();
    hideLoginModal();
    showNotification('Account created successfully! Welcome to the journey.');
}

function logout() {
    currentUser = null;
    localStorage.removeItem('kingCurrentUser');
    userAccountEl.style.display = 'none';
    showLoginModal();
    showNotification('You have been logged out.');
}

function updateUserAccountDisplay() {
    if (currentUser) {
        userAccountEl.style.display = 'flex';
        userAvatarEl.textContent = currentUser.username.charAt(0).toUpperCase();
        userNameEl.textContent = currentUser.username;
        
        // Calculate current day
        const currentDay = Math.floor((initialTime - timeLeft) / (24 * 60 * 60)) + 1;
        userStatsEl.textContent = `Day ${currentDay}`;
    } else {
        userAccountEl.style.display = 'none';
    }
}

// Settings functions
function showSettingsModal() {
    settingsModalEl.classList.add('active');
}

function hideSettingsModal() {
    settingsModalEl.classList.remove('active');
}

function updateSettingsToggles() {
    dailyRemindersToggle.classList.toggle('active', settings.dailyReminders);
    milestoneAlertsToggle.classList.toggle('active', settings.milestoneAlerts);
    motivationalMessagesToggle.classList.toggle('active', settings.motivationalMessages);
    saveDataToggle.classList.toggle('active', settings.saveData);
}

function toggleSetting(toggleElement, settingName) {
    toggleElement.classList.toggle('active');
    settings[settingName] = toggleElement.classList.contains('active');
    
    // Apply setting changes
    if (settingName === 'dailyReminders') {
        if (settings.dailyReminders) {
            startDailyReminders();
        } else if (dailyReminderInterval) {
            clearInterval(dailyReminderInterval);
            dailyReminderInterval = null;
        }
    } else if (settingName === 'motivationalMessages') {
        if (settings.motivationalMessages) {
            startMotivationalMessages();
        } else if (motivationalMessageInterval) {
            clearInterval(motivationalMessageInterval);
            motivationalMessageInterval = null;
        }
    }
}

function saveSettings() {
    saveData();
    hideSettingsModal();
    showNotification('Settings saved successfully.');
}

function clearData() {
    if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        // Clear user data
        if (currentUser) {
            localStorage.removeItem(`kingUserData_${currentUser.username}`);
        }
        
        // Reset all data
        streak = 0;
        initialTime = 48 * 60 * 60;
        timeLeft = 48 * 60 * 60;
        endTime = null;
        disciplinedMode = false;
        stats = {
            totalDays: 0,
            longestStreak: 0,
            goalsCompleted: 0,
            relapses: 0
        };
        savedMessage = {
            voice: null,
            text: null
        };
        
        // Stop timer if running
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        isRunning = false;
        startBtn.textContent = "START MISSION";
        startBtn.disabled = false;
        
        updateDisplay();
        updateStreakInfo();
        updateStatistics();
        
        showNotification('All data has been cleared.');
    }
}

function changePassword() {
    const newPassword = prompt('Enter your new password:');
    if (newPassword) {
        // Find and update user
        const userIndex = users.findIndex(u => u.username === currentUser.username);
        if (userIndex !== -1) {
            users[userIndex].password = newPassword;
            saveData();
            showNotification('Password changed successfully.');
        }
    }
}

function deleteAccount() {
    if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
        // Remove user from users array
        users = users.filter(u => u.username !== currentUser.username);
        
        // Remove user data
        localStorage.removeItem(`kingUserData_${currentUser.username}`);
        
        // Logout
        logout();
        
        showNotification('Your account has been deleted.');
    }
}

// Statistics functions
function showStatisticsModal() {
    updateStatistics();
    statsModalEl.classList.add('active');
}

function hideStatisticsModal() {
    statsModalEl.classList.remove('active');
}

function updateStatistics() {
    // Calculate total days
    if (isRunning) {
        const currentDay = Math.floor((initialTime - timeLeft) / (24 * 60 * 60)) + 1;
        stats.totalDays = Math.max(stats.totalDays, currentDay);
    }
    
    // Update display
    totalDaysEl.textContent = stats.totalDays;
    longestStreakEl.textContent = stats.longestStreak;
    goalsCompletedEl.textContent = stats.goalsCompleted;
    relapsesEl.textContent = stats.relapses;
}

function exportStats() {
    const statsData = {
        username: currentUser.username,
        stats: stats,
        currentStreak: streak,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(statsData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `king-stats-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('Statistics exported successfully.');
}

// Wake-Up Mode Functions
function activateWakeupMode() {
    wakeupModeEl.classList.add('active');
    showNotification("Wake-Up Mode activated. Prepare to face the truth.");
}

function exitWakeupMode() {
    wakeupModeEl.classList.remove('active');
    showNotification("You're awake. Now stay awake.");
}

function takeAction() {
    // Find current active tab
    const activeTab = document.querySelector('.tab-btn.active');
    const currentTabId = activeTab.getAttribute('data-tab');
    
    if (currentTabId === 'truth') {
        // Move to psychology tab
        document.querySelector('[data-tab="psychology"]').click();
        showNotification("Understanding the psychology is the next step.");
    } else if (currentTabId === 'psychology') {
        // Move to tactics tab
        document.querySelector('[data-tab="tactics"]').click();
        showNotification("Now it's time to break the cycle with these tactics.");
    } else if (currentTabId === 'tactics') {
        // Move to science tab
        document.querySelector('[data-tab="science"]').click();
        showNotification("Understanding the science will strengthen your resolve.");
    } else {
        // All tabs completed, close Wake-Up Mode
        exitWakeupMode();
        showNotification("You've completed Wake-Up Mode. Stay vigilant!");
    }
}

// Event listeners
startBtn.addEventListener('click', startMission);
resetBtn.addEventListener('click', resetStreak);
panicBtn.addEventListener('click', activateRedZone);
exitRedZoneBtn.addEventListener('click', exitRedZone);
breatheBtn.addEventListener('click', startBreathingExercise);
exitBreathingBtn.addEventListener('click', exitBreathingExercise);
motivationEl.addEventListener('click', getRandomMotivation);
disciplinedModeBtn.addEventListener('click', toggleDisciplinedMode);
recordMessageBtn.addEventListener('click', openMessageRecorder);
statsBtn.addEventListener('click', showStatisticsModal);
topWakeupBtn.addEventListener('click', activateWakeupMode);
exitWakeupBtn.addEventListener('click', exitWakeupMode);
takeActionBtn.addEventListener('click', takeAction);

// Red Zone distraction exercise
checkAnswerBtn.addEventListener('click', checkMathAnswer);
mathAnswerEl.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        checkMathAnswer();
    }
});

// Message recorder event listeners
recordBtn.addEventListener('click', startRecording);
playVoiceBtn.addEventListener('click', playRecordedAudio);
saveMessageBtn.addEventListener('click', saveMessage);
cancelRecordingBtn.addEventListener('click', closeMessageRecorder);

// Message playback event listeners
playMessageBtn.addEventListener('click', playSavedMessage);
closePlaybackBtn.addEventListener('click', closeMessagePlayback);

// User account event listeners
logoutBtn.addEventListener('click', logout);
closeLoginModalBtn.addEventListener('click', hideLoginModal);
loginBtn.addEventListener('click', login);
signupBtn.addEventListener('click', signup);
switchToSignupEl.addEventListener('click', (e) => {
    e.preventDefault();
    switchToSignup();
});
switchToLoginEl.addEventListener('click', (e) => {
    e.preventDefault();
    switchToLogin();
});

// Settings event listeners
settingsBtn.addEventListener('click', showSettingsModal);
closeSettingsModalBtn.addEventListener('click', hideSettingsModal);
dailyRemindersToggle.addEventListener('click', () => toggleSetting(dailyRemindersToggle, 'dailyReminders'));
milestoneAlertsToggle.addEventListener('click', () => toggleSetting(milestoneAlertsToggle, 'milestoneAlerts'));
motivationalMessagesToggle.addEventListener('click', () => toggleSetting(motivationalMessagesToggle, 'motivationalMessages'));
saveDataToggle.addEventListener('click', () => toggleSetting(saveDataToggle, 'saveData'));
clearDataBtn.addEventListener('click', clearData);
changePasswordBtn.addEventListener('click', changePassword);
deleteAccountBtn.addEventListener('click', deleteAccount);
saveSettingsBtn.addEventListener('click', saveSettings);

// Statistics event listeners
closeStatsModalBtn.addEventListener('click', hideStatisticsModal);
exportStatsBtn.addEventListener('click', exportStats);

// Tab switching functionality for Wake-Up Mode
tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');
        
        // Remove active class from all tabs and contents
        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        btn.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
    });
});

// Interactive items in Wake-Up Mode
interactiveItems.forEach(item => {
    item.addEventListener('click', function() {
        this.classList.toggle('expanded');
    });
});

// Tactic checkboxes
tacticCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            showNotification("Tactic marked as completed. Keep going!");
        }
    });
});

// Start quote rotation
function startQuoteRotation() {
    setInterval(() => {
        if (!isRunning || timeLeft > 24 * 60 * 60) {
            getRandomMotivation();
        }
    }, 30000);
}

// Initialize app
init();
